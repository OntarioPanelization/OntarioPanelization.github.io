<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Model Viewer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; text-align: center; }
        .container { padding: 2rem; }
        .message { font-size: 1.2rem; color: #333; }
        .fallback { display: none; margin-top: 1.5rem; }
        .fallback a { display: block; margin: 0.5rem 0; font-size: 1rem; }
        a[rel="ar"] { display: none; } /* Hide the AR link */
    </style>
</head>
<body>
    <div class="container">
        <p id="status-message" class="message">Loading AR Experience...</p>
        <div id="fallback-container" class="fallback">
            <p class="message">Automatic launch failed. Your device may not support AR.</p>
            <p>You can download the models directly:</p>
            <a id="fallback-ios-link" href="#">Download for Apple (USDZ)</a>
            <a id="fallback-android-link" href="#">Download for Android (GLB)</a>
        </div>
    </div>

    <script>
        window.onload = function() {
            const messageElement = document.getElementById('status-message');
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;

            try {
                const urlParams = new URLSearchParams(window.location.search);
                // Make the script backward compatible by also checking for the old "model" parameter.
                const iosModelUrl = urlParams.get('ios_model') || urlParams.get('model');
                const androidModelUrl = urlParams.get('android_model') || urlParams.get('model');

                // Only throw an error if NO model URLs are found.
                if (!iosModelUrl && !androidModelUrl) { 
                    throw new Error('No model URL specified.');
                }

                // Set up fallback links immediately
                document.getElementById('fallback-ios-link').href = iosModelUrl;
                document.getElementById('fallback-android-link').href = androidModelUrl;

                let fallbackTimeout = setTimeout(() => {
                    document.getElementById('fallback-container').style.display = 'block';
                }, 2500); // Show fallback after 2.5 seconds

                window.addEventListener("pageshow", function(event) {
                    // If the user navigates back to this page, the timeout should be cleared.
                    clearTimeout(fallbackTimeout);
                });

                // Check for iOS/iPadOS devices (including iPads that identify as Macs)
                const isAppleDevice = /iPad|iPhone|iPod/.test(userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

                if (isAppleDevice && iosModelUrl) { // If it's an Apple device AND we have an iOS model
                    messageElement.textContent = 'Launching AR on your Apple device...';
                    // Create an AR Quick Look link dynamically
                    const arLink = document.createElement('a');
                    arLink.setAttribute('rel', 'ar');
                    arLink.setAttribute('href', iosModelUrl);
                    document.body.appendChild(arLink);
                    arLink.click(); // This will trigger AR Quick Look
                } else if (androidModelUrl) { // Otherwise, if we have an Android model, use it
                    // Assume Android for all other devices
                    messageElement.textContent = 'Launching AR on your Android device...';
                    const sceneViewerUrl = `intent://arvr.google.com/scene-viewer/1.0?file=${androidModelUrl}&mode=ar_preferred#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.VIEW;S.browser_fallback_url=${androidModelUrl};end;`;
                    window.location.href = sceneViewerUrl;
                }

            } catch (error) {
                messageElement.textContent = 'An error occurred while loading the model: ' + error.message;
                console.error(error);
            }
        };
    </script>
</body>
</html>
